name: CI

on:
  push:

permissions: {}

jobs:
  release:
    name: Release
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: write
    outputs:
      version: ${{ steps.release.outputs.version }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          sparse-checkout: .release-it.json
          sparse-checkout-cone-mode: false
      - uses: actions/setup-node@v6
        with:
          node-version: 24
      - name: Release
        id: release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_IT="npx --yes --package release-it --package @release-it/conventional-changelog release-it"

          if [ "${{ github.ref_name }}" != "main" ]; then
            LABEL=$(echo "${{ github.ref_name }}" | tr '/' '-')
            ARGS="--preRelease=$LABEL"
          fi

          VERSION=$($RELEASE_IT --release-version $ARGS 2>/dev/null || true)

          if [ -n "$VERSION" ]; then
            $RELEASE_IT --ci $ARGS
            echo "version=v${VERSION}" >> "$GITHUB_OUTPUT"
          fi

  build:
    name: Build firmware
    needs: publish-builder
    runs-on: ubuntu-24.04-arm
    container: ghcr.io/${{ github.repository }}/builder:sha-${{ github.sha }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1
      - name: Build firmware
        run: |
          . $IDF_PATH/export.sh
          idf.py --preview build
      - name: Convert to flashable binary
        run: |
          . $IDF_PATH/export.sh
          esptool.py --chip esp32c5 merge_bin -o moto.bin --flash_mode dio --flash_size 4MB 0x0 build/bootloader/bootloader.bin 0x8000 build/partition_table/partition-table.bin 0x10000 build/moto.bin
      - uses: actions/upload-artifact@v6
        with:
          name: firmware
          path: moto.bin

  publish:
    name: Publish firmware
    needs: [release, build]
    if: needs.release.outputs.version != ''
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v6
        with:
          name: firmware
      - name: Upload firmware to release
        run: gh release upload ${{ needs.release.outputs.version }} moto.bin --repo ${{ github.repository }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-builder:
    name: Publish builder image
    runs-on: ubuntu-24.04-arm
    permissions:
      packages: write
    steps:
      - uses: actions/checkout@v6
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/metadata-action@v5
        id: meta
        with:
          images: ghcr.io/${{ github.repository }}/builder
          tags: |
            type=sha,format=long
            type=raw,value=latest,enable=${{ github.ref_name == 'main' }}
            type=raw,value={{branch}},enable=${{ github.ref_name != 'main' }}
      - uses: docker/build-push-action@v6
        with:
          context: .
          target: builder
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=ghcr.io/${{ github.repository }}/builder:cache
          cache-to: type=registry,ref=ghcr.io/${{ github.repository }}/builder:cache,mode=max
