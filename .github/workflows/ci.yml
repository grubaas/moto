name: CI

on:
  push:

permissions: {}

jobs:
  release:
    name: Release
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: write
    outputs:
      version: ${{ steps.release.outputs.version }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          sparse-checkout: .release-it.json
          sparse-checkout-cone-mode: false
      - uses: actions/setup-node@v6
        with:
          node-version: 24
      - name: Release
        id: release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_IT="npx --yes --package release-it --package @release-it/conventional-changelog release-it"

          if [ "${{ github.ref_name }}" != "main" ]; then
            LABEL=$(echo "${{ github.ref_name }}" | tr '/' '-')
            ARGS="--preRelease=$LABEL"
          fi

          VERSION=$($RELEASE_IT --release-version $ARGS 2>/dev/null || true)

          if [ -n "$VERSION" ]; then
            $RELEASE_IT --ci $ARGS
            echo "version=v${VERSION}" >> "$GITHUB_OUTPUT"
          fi

  build:
    name: Build firmware
    runs-on: ubuntu-24.04-arm
    container: rust:1-bookworm
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1
      - name: Add RISC-V target
        run: rustup target add riscv32imac-unknown-none-elf
      - name: Build firmware
        run: cargo build --release
      - uses: actions/upload-artifact@v6
        with:
          name: firmware
          path: target/riscv32imac-unknown-none-elf/release/moto

  simulate:
    name: Run in Renode
    needs: build
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v6
      - name: Install Renode (native arm64 portable .NET build)
        run: |
          sudo apt-get update && sudo apt-get install -y --no-install-recommends \
            libicu74 libssl3t64 wget
          wget -qO /tmp/renode.tar.gz \
            https://builds.renode.io/renode-latest.linux-arm64-portable-dotnet.tar.gz
          sudo mkdir -p /opt/renode
          sudo tar -xzf /tmp/renode.tar.gz -C /opt/renode --strip-components=1
          rm /tmp/renode.tar.gz
          echo "/opt/renode" >> "$GITHUB_PATH"
      - uses: actions/download-artifact@v6
        with:
          name: firmware
      - name: Simulate firmware and verify breathing LED
        run: |
          renode --disable-xwt --console \
            -e '$bin = @moto' \
            -e 'include @renode/esp32c5.resc' \
            -e 'emulation RunFor "00:00:01.000"' \
            -e 'quit' \
            2>&1 | tee output.txt
          echo "--- Renode output ---"
          cat output.txt

          echo "--- Checking UART breathing pattern ---"
          grep -q "breathing LED" output.txt
          grep -q "breathe: peak" output.txt
          grep -q "breathe: trough" output.txt

          echo "--- Checking GPIO brightness curve ---"
          # Extract all brightness percentages logged by the system bus write hook
          grep -oP 'brightness: \K[0-9]+' output.txt > brightness.txt
          cat brightness.txt

          # Verify the full range is covered (low / mid / high)
          awk '$1 <= 5  { low=1 }
               $1 >= 40 && $1 <= 60 { mid=1 }
               $1 >= 95 { high=1 }
               END {
                 ok = 1
                 if (!low)  { print "FAIL: no brightness <= 5% (trough)";  ok = 0 }
                 if (!mid)  { print "FAIL: no brightness 40-60% (midpoint)"; ok = 0 }
                 if (!high) { print "FAIL: no brightness >= 95% (peak)";  ok = 0 }
                 if (ok) print "PASS: brightness spans full range"
                 exit !ok
               }' brightness.txt

          echo "PASS: Breathing LED verified (UART + GPIO brightness)."

  publish:
    name: Publish firmware
    needs: [release, build]
    if: needs.release.outputs.version != ''
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v6
        with:
          name: firmware
      - name: Upload firmware to release
        run: gh release upload ${{ needs.release.outputs.version }} moto --repo ${{ github.repository }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-builder:
    name: Publish builder image
    runs-on: ubuntu-24.04-arm
    permissions:
      packages: write
    steps:
      - uses: actions/checkout@v6
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/metadata-action@v5
        id: meta
        with:
          images: ghcr.io/${{ github.repository }}/builder
          tags: |
            type=sha
            type=raw,value=latest,enable=${{ github.ref_name == 'main' }}
            type=raw,value={{branch}},enable=${{ github.ref_name != 'main' }}
      - uses: docker/build-push-action@v6
        with:
          context: .
          target: builder
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=ghcr.io/${{ github.repository }}/builder:cache
          cache-to: type=registry,ref=ghcr.io/${{ github.repository }}/builder:cache,mode=max
